#! /bin/bash

usage()
{
cat << EOF
usage: $0 options

Make a pedestal file for offline use

OPTIONS:
-r runnumber
-e <expname> 
-d <directory for littleData file>
-f <filename is not standard>
EOF
}

RUN=-1
EXP='xxx'
DIRNAME='xxx'
FNAME='xxx'
while getopts "r:e:d:f:h" OPTION
do
    case $OPTION in
	h)
	    usage
	    exit 1
	    ;;
	r)
	    RUN=$OPTARG
	    ;;
	e)
	    EXP=$OPTARG
	    ;;
	d)
	    DIRNAME=$OPTARG
	    ;;
	f)
	    FNAME=$OPTARG
	    ;;
	?)
	    usage
	    exit
	    ;;
    esac
 done

## use for new environment scheme
unset PYTHONPATH
unset LD_LIBRARY_PATH

IN_PROMPT="--PromptManager.in_template='LDana In [\#]: '"
OUT_PROMPT="--PromptManager.out_template='LDana Out[\#]: '"

## source the analysis environment script
. /reg/g/psdm/etc/ana_env.sh 

if [ -d './xppmodules/scripts/' ]; then
    LDAP='xppmodules' 
elif  [ $EXP == 'xxx' ]; then
    LOCEXP=`/reg/g/xpp/scripts/get_curr_exp`
    HUTCH=${LOCEXP:0:3}
    LDAP='/reg/d/psdm/'$HUTCH'/'$LOCEXP'/res/littleData/xppmodules'
else
    HUTCH=${EXP:0:3}
    LDAP='/reg/d/psdm/'$HUTCH'/'$EXP'/res/littleData/xppmodules'
fi
source /reg/g/pcds/setup/pathmunge.sh
pythonpathmunge $LDAP
pythonpathmunge $LDAP/src
pythonpathmunge $LDAP/scripts

if [ $RUN -le 0 ]; then
    CMD="%run $LDAP/scripts/LoadLittleDataAna.py"
    EXP=`/reg/g/xpp/scripts/get_curr_exp`
elif  [ $EXP != 'xxx' ]; then
    CMD="%run $LDAP/scripts/LoadLittleDataAna.py --run $RUN --exp $EXP"
else
    CMD="%run $LDAP/scripts/LoadLittleDataAna.py --run $RUN"
    EXP=`/reg/g/xpp/scripts/get_curr_exp`
fi
if  [ $DIRNAME != 'xxx' ]; then
    CMD="$CMD --dir $DIRNAME"
fi
if  [ $FNAME != 'xxx' ]; then
    CMD="$CMD --file $FNAME"
fi

echo $CMD 
if [[ $EXP =~ 'xpp' ]]; then
    HUTCH='xpp'
else
    HUTCH='xcs'
fi

ipython --no-banner --no-confirm-exit -i "${IN_PROMPT}" "${OUT_PROMPT}" -c "$CMD"
