#!/bin/bash

export PATH=$PATH:/reg/g/xpp/scripts:/reg/neh/operator/xppopr/bin
CURREXP=`get_curr_exp`
if [[ $CURREXP =~ 'xpp' ]]; then
    HUTCH='xpp'
else
    HUTCH='xcs'
fi
cd /reg/d/psdm/$HUTCH/$CURREXP/results/littleData

LASTRUN=`get_lastRun`
while true; do
	CREATE_TIME=`date '+%m/%d/%Y_%H:%M:%S'`
        LDATRUN_H5=`ls -t /reg/d/psdm/$HUTCH/$CURREXP/hdf5/smalldata/ldat_$CURREXP_Run*.h5 | grep -vi cube | head -n1 | sed s:/reg/d/psdm/$HUTCH/$CURREXP/hdf5/smalldata/ldat_$CURREXP\_Run::g | sed s/.h5//g`
        CUBERUN_H5=`ls -t /reg/d/psdm/$HUTCH/$CURREXP/hdf5/smalldata/Cube_$CURREXP_Run*.h5 | head -n1 | sed s:/reg/d/psdm/$HUTCH/$CURREXP/hdf5/smalldata/ldat_$CURREXP\_Run::g | sed s/.h5//g`
        HASH5=`ls -t /reg/d/psdm/$HUTCH/$CURREXP/hdf5/smalldata/Cube_$CURREXP_Run*$LASTRUN*.h5 | wc | awk {'print $1'}`
	echo 'Last Run: '$LDATRUN_H5 ', latest cube file: ' $CUBERUN_H5 ', checked at ' $CREATE_TIME ', checking to process run ' $LASTRUN

	if [ $LDATRUN_H5 -ge $LASTRUN ]; then
	    if [ $HASH5 -eq 1 ]; then
		echo 'we have processed run ' $LASTRUN 'offline already'
		let "LASTRUN+=1" 
	    else
		echo 'send ffb job for run ' $LASTRUN 
		#./cubeRun -q psnehprioq -c CubeSetup_delay.txt -r $LASTRUN -m 5 -t 25
		./cubeRun -q psnehprioq -c CubeSetup_delay.txt -r $LASTRUN
		let "LASTRUN+=1" 
		sleep 60
	    fi
	fi
	sleep 10
done
